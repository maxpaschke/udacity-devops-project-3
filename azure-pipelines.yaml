name: Azure Pipelines
variables:
  python.version: "3.7.9"
  appName: 'TestApp-AppService'

stages:
  # - stage: Provision
  #   jobs:
  #     - job: Provision
  #       displayName: Run Terraform
  #       pool:
  #         name: Default
  #       steps:
  #       - task: InstallSSHKey@0
  #         inputs:
  #             knownHostsEntry: 'KNOWN_HOSTS_STRING'
  #             sshKeySecureFile: 'id_rsa'
  #       - task: DownloadSecureFile@1
  #         displayName: Download the modified vars file
  #         name: terraformvars
  #         inputs:
  #           secureFile: "terraform.tfvars"    
  #       - task: DownloadSecureFile@1
  #         displayName: Download the modified backend file
  #         name: terraformbackend
  #         inputs:
  #           secureFile: "terraform_backend.conf"
  #       - task: DownloadSecureFile@1
  #         displayName: Download the modified backend file
  #         name: rsakey
  #         inputs:
  #          secureFile: "id_rsa.pub"
  #       - task: CopyFiles@2
  #         displayName: Copy the secure files
  #         inputs:
  #           SourceFolder: '$(Agent.TempDirectory)'
  #           Contents: '**'
  #           TargetFolder: 'terraform'
  #       # - task: Bash@3
  #       #   displayName: Install Terraform
  #       #   inputs:
  #       #     filePath: 'terraform/install_terraform.sh'
  #       #     workingDirectory: 'terraform'
  #       - task: Bash@3
  #         displayName: Init Terraform
  #         inputs:
  #           targetType: 'inline'
  #           script: 'terraform init --backend-config=terraform_backend.conf --reconfigure'
  #           workingDirectory: 'terraform'
  #       # - task: Bash@3
  #       #   displayName: Import RG
  #       #   inputs:
  #       #     filePath: 'terraform/import_resource_group.sh'
  #       #     workingDirectory: 'terraform'
  #       - task: Bash@3
  #         inputs:
  #           targetType: 'inline'
  #           script: |
  #             # Write your commands here
  #             ls /home/vmadmin/myagent/myagent/_work/_temp/
  #       - task: Bash@3
  #         displayName: Apply Terraform
  #         inputs:
  #           targetType: 'inline'
  #           script: 'terraform apply'
  #           workingDirectory: 'terraform'





  - stage: Build
    jobs:
      - job: Build
        pool:
          name: Default
        steps:
          - task: Bash@3
            displayName: Install zip
            inputs:
              targetType: 'inline'
              script: |
                sudo apt-get update
                sudo apt-get install zip unzip
          - task: ArchiveFiles@2
            displayName: "Archive FakeRestAPI"
            inputs:
              rootFolderOrFile: "automatedtesting/jmeter/fakerestapi"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip"
          - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip
            displayName: "Upload Package"
            artifact: drop-fakerestapi
  - stage: FakeRestAPI
    jobs:
      - deployment: FakeRestAPI
        pool:
          name: Default
        environment: "TEST"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: "Deploy Azure Web App"
                  inputs:
                    azureSubscription: "azure"
                    appName: $(appName)
                    appType: webApp
                    package: $(Pipeline.Workspace)/drop-fakerestapi/$(Build.BuildId)-fakerestapi.zip
    # - deployment: VMDeploy
    #   displayName: NAME
    #   environment:
    #     name:  ENVIRONMENT NAME
    #     resourceType: VirtualMachine
    #     tags: TAG NAME
    #   strategy:
    #     runOnce:
    #       deploy:
    #         steps:
    #         - task: Bash@3
    #           inputs:
    #             targetType: 'inline'
    #             script: |
    #               #! /bin/bash

    #               sudo apt-get upgrade -y
    #               sudo apt-get install python3-pip -y
    #               sudo apt-get install unzip -y
    #               sudo apt-get install -y chromium-browser
    #               pip3 install selenium
    #               export PATH=$PATH:some/path

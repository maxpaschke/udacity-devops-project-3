name: Azure Pipelines
variables:
  python.version: "3.7.9"
  appName: 'TestApp-AppService'

stages:
##########################################################################################
  # - stage: Provision
  #   jobs:
  #     - job: Provision
  #       displayName: Run Terraform
  #       pool:
  #         name: Default
  #       steps:
  #       - task: InstallSSHKey@0
  #         inputs:
  #             knownHostsEntry: 'KNOWN_HOSTS_STRING'
  #             sshKeySecureFile: 'id_rsa'
  #       - task: DownloadSecureFile@1
  #         displayName: Download the modified vars file
  #         name: terraformvars
  #         inputs:
  #           secureFile: "terraform.tfvars"    
  #       - task: DownloadSecureFile@1
  #         displayName: Download the modified backend file
  #         name: terraformbackend
  #         inputs:
  #           secureFile: "terraform_backend.conf"
  #       - task: DownloadSecureFile@1
  #         displayName: Download the modified backend file
  #         name: rsakey
  #         inputs:
  #          secureFile: "id_rsa.pub"
  #       - task: CopyFiles@2
  #         displayName: Copy the secure files
  #         inputs:
  #           SourceFolder: '$(Agent.TempDirectory)'
  #           Contents: '**'
  #           TargetFolder: 'terraform'
  #       - task: Bash@3
  #         displayName: Install Terraform
  #         inputs:
  #           filePath: 'terraform/install_terraform.sh'
  #           workingDirectory: 'terraform'
  #       - task: Bash@3
  #         displayName: Init Terraform
  #         inputs:
  #           targetType: 'inline'
  #           script: 'terraform init --backend-config=terraform_backend.conf --reconfigure'
  #           workingDirectory: 'terraform'
  #       # - task: Bash@3
  #       #   displayName: Import RG
  #       #   inputs:
  #       #     filePath: 'terraform/import_resource_group.sh'
  #       #     workingDirectory: 'terraform'
  #       - task: Bash@3
  #         displayName: Apply Terraform
  #         inputs:
  #           targetType: 'inline'
  #           script: 'terraform apply -auto-approve'
  #           workingDirectory: 'terraform'

##########################################################################################
  - stage: BuildFakeRestApi
    jobs:
      - job: Build
        pool:
          name: Default
        steps:
          - task: Bash@3
            displayName: Install zip
            inputs:
              targetType: 'inline'
              script: |
                sudo apt-get update
                sudo apt-get install zip unzip
          - task: ArchiveFiles@2
            displayName: "Archive FakeRestAPI"
            inputs:
              rootFolderOrFile: "automatedtesting/jmeter/fakerestapi"
              includeRootFolder: false
              archiveType: "zip"
              archiveFile: "$(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip"
          - publish: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-fakerestapi.zip
            displayName: "Upload Package"
            artifact: drop-fakerestapi

##########################################################################################
  - stage: DeployFakeRestApi
    jobs:
      - deployment: FakeRestAPI
        pool:
          name: Default
        environment: "TEST"
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: "Deploy Azure Web App"
                  inputs:
                    azureSubscription: "azure"
                    appName: $(appName)
                    appType: webApp
                    package: $(Pipeline.Workspace)/drop-fakerestapi/$(Build.BuildId)-fakerestapi.zip

###########################################################################################
  # - stage: Tests
  #   jobs:
  #   - job: Integrationtests
  #     pool:
  #       name: Default
  #     displayName: 'Integration Tests'
  #     steps:
  #       - task: NodeTool@0
  #         displayName: 'Install node'
  #         inputs:
  #           versionSpec: '16.x'
  #       - task: Bash@3
  #         displayName: 'Install newman'
  #         inputs:
  #           targetType: 'inline'
  #           script: |
  #             npm install -g newman
  #             newman --version
  #             mkdir logs
  #             mkdir logs/postman
  #             mkdir Results
            
  #       - task: Bash@3
  #         displayName: 'Run the regression tests'
  #         inputs:
  #           workingDirectory: '$(System.DefaultWorkingDirectory)'
  #           filePath: 'automatedtesting/postman/run_regression_tests.sh'
  #       - task: Bash@3
  #         displayName: 'Run the validation tests'
  #         inputs:
  #           workingDirectory: '$(System.DefaultWorkingDirectory)'
  #           filePath: 'automatedtesting/postman/run_validation_tests.sh'
  #       - task: Bash@3
  #         displayName: 'Show test result files'
  #         inputs:
  #           targetType: 'inline'
  #           script: |
  #             ls ./Results/
  #       - task: PublishTestResults@2
  #         displayName: Publish the Postman results
  #         condition: always()
  #         inputs:
  #           testResultsFormat: 'JUnit'
  #           testResultsFiles: 'Results/*.xml'
  #           mergeTestResults: true
      
  - stage: LoadTesting
    jobs:
     - job: jmeterTests
       pool:
        name: Default
       displayName: 'Run Jmeter Tests'
       steps:
         - task: Bash@3
           displayName: 'Install jmeter'
           inputs:
             targetType: 'inline'
             script: |
               sudo apt-get install default-jre -y
               wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.4.tgz -O jmeter-5.4.tgz
               tar -xzvf jmeter-5.4.tgz
               ./apache-jmeter-5.4/bin/jmeter --version












    # - deployment: VMDeploy
    #   displayName: NAME
    #   environment:
    #     name:  ENVIRONMENT NAME
    #     resourceType: VirtualMachine
    #     tags: TAG NAME
    #   strategy:
    #     runOnce:
    #       deploy:
    #         steps:
    #         - task: Bash@3
    #           inputs:
    #             targetType: 'inline'
    #             script: |
    #               #! /bin/bash

    #               sudo apt-get upgrade -y
    #               sudo apt-get install python3-pip -y
    #               sudo apt-get install unzip -y
    #               sudo apt-get install -y chromium-browser
    #               pip3 install selenium
    #               export PATH=$PATH:some/path
